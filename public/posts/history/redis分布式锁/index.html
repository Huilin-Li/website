<!DOCTYPE html>
<html lang="en-us" dir="ltr">
<head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="description" content="&lt;dependency&gt; &lt;groupId&gt;redis.clients&lt;/groupId&gt; &lt;artifactId&gt;jedis&lt;/artifactId&gt; &lt;version&gt;3.0.1&lt;/version&gt; &lt;/dependency&gt; LockUtil
public class LockUtil { private static final JedisPool JEDIS_POOL; /** 锁过期时间 */ private static final long INTERNAL_LOCK_LEASE_TIME = 5000; private final static long TIME_OUT = 20000; //获取锁的超时时间 private static final SetParams PARAMS = SetParams.setParams().nx().px(INTERNAL_LOCK_LEASE_TIME); static { JEDIS_POOL = new JedisPool(&#34;139.9.183.232&#34;, 6379); } private static Jedis getJedis() { Jedis resource = JEDIS_POOL.getResource(); resource.auth(&#34;yuanmoc&#34;); return resource; } public static boolean lock(String lockKey, String sessionId) { Jedis jedis = getJedis(); long start = System.">
<meta name="theme-color" media="(prefers-color-scheme: light)" content="#ffffff">
<meta name="theme-color" media="(prefers-color-scheme: dark)" content="#343a40">
<meta name="color-scheme" content="light dark"><meta property="og:title" content="Redis分布式锁" />
<meta property="og:description" content="&lt;dependency&gt; &lt;groupId&gt;redis.clients&lt;/groupId&gt; &lt;artifactId&gt;jedis&lt;/artifactId&gt; &lt;version&gt;3.0.1&lt;/version&gt; &lt;/dependency&gt; LockUtil
public class LockUtil { private static final JedisPool JEDIS_POOL; /** 锁过期时间 */ private static final long INTERNAL_LOCK_LEASE_TIME = 5000; private final static long TIME_OUT = 20000; //获取锁的超时时间 private static final SetParams PARAMS = SetParams.setParams().nx().px(INTERNAL_LOCK_LEASE_TIME); static { JEDIS_POOL = new JedisPool(&#34;139.9.183.232&#34;, 6379); } private static Jedis getJedis() { Jedis resource = JEDIS_POOL.getResource(); resource.auth(&#34;yuanmoc&#34;); return resource; } public static boolean lock(String lockKey, String sessionId) { Jedis jedis = getJedis(); long start = System." />
<meta property="og:type" content="article" />
<meta property="og:url" content="http://localhost:1313/posts/history/redis%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2021-12-29T00:45:40+00:00" />
<meta property="article:modified_time" content="2021-12-29T00:45:40+00:00" />

<title>Redis分布式锁 | Huilin Li</title>
<link rel="manifest" href="/manifest.json">
<link rel="icon" href="/logo.png" >
<link rel="canonical" href="http://localhost:1313/posts/history/redis%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81/">
<link rel="stylesheet" href="/book.min.f3de075a26891530cb4ae6aeb9b647bcc541281bbd3ec57e8bf60cb157bc209f.css" integrity="sha256-894HWiaJFTDLSuauubZHvMVBKBu9PsV&#43;i/YMsVe8IJ8=" crossorigin="anonymous">
  <script defer src="/flexsearch.min.js"></script>
  <script defer src="/en.search.min.63b6564d7b3b31dd72b69135cc6c6b73c5ad27a2c8e9373f7ae6f091b7281354.js" integrity="sha256-Y7ZWTXs7Md1ytpE1zGxrc8WtJ6LI6Tc/eubwkbcoE1Q=" crossorigin="anonymous"></script>

  <script defer src="/sw.min.6f6f90fcb8eb1c49ec389838e6b801d0de19430b8e516902f8d75c3c8bd98739.js" integrity="sha256-b2&#43;Q/LjrHEnsOJg45rgB0N4ZQwuOUWkC&#43;NdcPIvZhzk=" crossorigin="anonymous"></script>
<!--
Made with Book Theme
https://github.com/alex-shpak/hugo-book
-->
  
</head>
<body dir="ltr">
  <input type="checkbox" class="hidden toggle" id="menu-control" />
  <input type="checkbox" class="hidden toggle" id="toc-control" />
  <main class="container flex">
    <aside class="book-menu">
      <div class="book-menu-content">
        
  <nav>
<h2 class="book-brand">
  <a class="flex align-center" href="/"><img src="/logo.png" alt="Logo" /><span>Huilin Li</span>
  </a>
</h2>


<div class="book-search">
  <input type="text" id="book-search-input" placeholder="Search" aria-label="Search" maxlength="64" data-hotkeys="s/" />
  <div class="book-search-spinner hidden"></div>
  <ul id="book-search-results"></ul>
</div>












  



  
  <ul>
    
      
        <li class="book-section-flat" >
          
  
  

  
    <a href="/docs/me/" class="">Keep Things Simple</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li class="book-section-flat" >
          
  
  

  
    <span>Blog</span>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="/docs/blogs/bioworld/" class="">Biology World</a>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="/docs/blogs/bioworld/binderdesign/" class="">TP Binder Design</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/blogs/bioworld/proteinstruture/" class="">4 levels of protein structure</a>
  

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/blogs/hugo/" class="">Hugo</a>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="/docs/blogs/hugo/hugobookgithubaction/" class="">HugoBook&#43;GithubAction</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/blogs/hugo/hugo/" class="">Hugo Commands</a>
  

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/docs/blogs/shell/" class="">Bash Scripts</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <span>literature</span>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <span>Plotly</span>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="/docs/blogs/plotly/examples/" class="">Visualization via plotly</a>
  

        </li>
      
    
  </ul>

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li class="book-section-flat" >
          
  
  

  
    <a href="/docs/travel/" class="">World</a>
  

          
  <ul>
    
  </ul>

        </li>
      
    
  </ul>











  
<ul>
  
  <li>
    <a href="/posts/"  >
        我的博客
      </a>
  </li>
  
  <li>
    <a href="https://github.com/Huilin-Li"  target="_blank" rel="noopener">
        Github
      </a>
  </li>
  
  <li>
    <a href="https://www.goodreads.com/review/list/177314441"  target="_blank" rel="noopener">
        goodreads
      </a>
  </li>
  
</ul>






</nav>




  <script>(function(){var e=document.querySelector("aside .book-menu-content");addEventListener("beforeunload",function(){localStorage.setItem("menu.scrollTop",e.scrollTop)}),e.scrollTop=localStorage.getItem("menu.scrollTop")})()</script>


 
      </div>
    </aside>

    <div class="book-page">
      <header class="book-header">
        
  <div class="flex align-center justify-between">
  <label for="menu-control">
    <img src="/svg/menu.svg" class="book-icon" alt="Menu" />
  </label>

  <strong>Redis分布式锁</strong>

  <label for="toc-control">
    
    <img src="/svg/toc.svg" class="book-icon" alt="Table of Contents" />
    
  </label>
</div>


  
  <aside class="hidden clearfix">
    
  
<nav id="TableOfContents"></nav>



  </aside>
  
 
      </header>

      
      
<article class="markdown book-post">
  <h1>
    <a href="/posts/history/redis%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81/">Redis分布式锁</a>
  </h1>
  
  <h5>December 29, 2021</h5>



  

  
  <div>
    
      <a href="/tags/2023-05-07%E4%BB%8Ehalo%E5%8D%9A%E5%AE%A2%E8%BF%81%E7%A7%BB/">2023-05-07从halo博客迁移</a>
  </div>
  



<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-xml" data-lang="xml"><span style="display:flex;"><span>        <span style="color:#f92672">&lt;dependency&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">&lt;groupId&gt;</span>redis.clients<span style="color:#f92672">&lt;/groupId&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">&lt;artifactId&gt;</span>jedis<span style="color:#f92672">&lt;/artifactId&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">&lt;version&gt;</span>3.0.1<span style="color:#f92672">&lt;/version&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&lt;/dependency&gt;</span>
</span></span></code></pre></div><p>LockUtil</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">LockUtil</span> {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">final</span> JedisPool JEDIS_POOL;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/** 锁过期时间 */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">final</span> <span style="color:#66d9ef">long</span> INTERNAL_LOCK_LEASE_TIME <span style="color:#f92672">=</span> 5000;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">final</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">long</span> TIME_OUT <span style="color:#f92672">=</span> 20000; <span style="color:#75715e">//获取锁的超时时间</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">final</span> SetParams PARAMS <span style="color:#f92672">=</span> SetParams.<span style="color:#a6e22e">setParams</span>().<span style="color:#a6e22e">nx</span>().<span style="color:#a6e22e">px</span>(INTERNAL_LOCK_LEASE_TIME);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">static</span> {
</span></span><span style="display:flex;"><span>        JEDIS_POOL <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> JedisPool(<span style="color:#e6db74">&#34;139.9.183.232&#34;</span>, 6379);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">static</span> Jedis <span style="color:#a6e22e">getJedis</span>() {
</span></span><span style="display:flex;"><span>        Jedis resource <span style="color:#f92672">=</span> JEDIS_POOL.<span style="color:#a6e22e">getResource</span>();
</span></span><span style="display:flex;"><span>        resource.<span style="color:#a6e22e">auth</span>(<span style="color:#e6db74">&#34;yuanmoc&#34;</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> resource;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">boolean</span> <span style="color:#a6e22e">lock</span>(String lockKey, String sessionId) {
</span></span><span style="display:flex;"><span>        Jedis jedis <span style="color:#f92672">=</span> getJedis();
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">long</span> start <span style="color:#f92672">=</span> System.<span style="color:#a6e22e">currentTimeMillis</span>();
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">try</span>{
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">for</span>(;;){
</span></span><span style="display:flex;"><span>                <span style="color:#75715e">// SET命令返回OK ，则证明获取锁成功</span>
</span></span><span style="display:flex;"><span>                System.<span style="color:#a6e22e">out</span>.<span style="color:#a6e22e">println</span>(Thread.<span style="color:#a6e22e">currentThread</span>().<span style="color:#a6e22e">getName</span>() <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34; - 正在获取锁&#34;</span>);
</span></span><span style="display:flex;"><span>                String lock <span style="color:#f92672">=</span> jedis.<span style="color:#a6e22e">set</span>(lockKey, sessionId, PARAMS);
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">if</span>(<span style="color:#e6db74">&#34;OK&#34;</span>.<span style="color:#a6e22e">equals</span>(lock)){
</span></span><span style="display:flex;"><span>                    System.<span style="color:#a6e22e">out</span>.<span style="color:#a6e22e">println</span>(Thread.<span style="color:#a6e22e">currentThread</span>().<span style="color:#a6e22e">getName</span>() <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34; - 获取锁成功&#34;</span>);
</span></span><span style="display:flex;"><span>                    <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">true</span>;
</span></span><span style="display:flex;"><span>                }
</span></span><span style="display:flex;"><span>                <span style="color:#75715e">// 否则循环等待，在timeout时间内仍未获取到锁，则获取失败</span>
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">long</span> l <span style="color:#f92672">=</span> System.<span style="color:#a6e22e">currentTimeMillis</span>() <span style="color:#f92672">-</span> start;
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">if</span> (l <span style="color:#f92672">&gt;=</span> TIME_OUT) {
</span></span><span style="display:flex;"><span>                    System.<span style="color:#a6e22e">out</span>.<span style="color:#a6e22e">println</span>(Thread.<span style="color:#a6e22e">currentThread</span>().<span style="color:#a6e22e">getName</span>() <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34; - 获取锁超时&#34;</span>);
</span></span><span style="display:flex;"><span>                    <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">false</span>;
</span></span><span style="display:flex;"><span>                }
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">try</span> {
</span></span><span style="display:flex;"><span>                    Thread.<span style="color:#a6e22e">sleep</span>(100);
</span></span><span style="display:flex;"><span>                } <span style="color:#66d9ef">catch</span> (InterruptedException e) {
</span></span><span style="display:flex;"><span>                    e.<span style="color:#a6e22e">printStackTrace</span>();
</span></span><span style="display:flex;"><span>                }
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        }<span style="color:#66d9ef">finally</span> {
</span></span><span style="display:flex;"><span>            jedis.<span style="color:#a6e22e">close</span>();
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">boolean</span> <span style="color:#a6e22e">unlock</span>(String lockKey, String sessionId){
</span></span><span style="display:flex;"><span>        Jedis jedis <span style="color:#f92672">=</span> getJedis();
</span></span><span style="display:flex;"><span>        String script <span style="color:#f92672">=</span>
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#34;if redis.call(&#39;get&#39;,KEYS[1]) == ARGV[1] then&#34;</span> <span style="color:#f92672">+</span>
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#34;   return redis.call(&#39;del&#39;,KEYS[1]) &#34;</span> <span style="color:#f92672">+</span>
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#34;else&#34;</span> <span style="color:#f92672">+</span>
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#34;   return 0 &#34;</span> <span style="color:#f92672">+</span>
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#34;end&#34;</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">try</span> {
</span></span><span style="display:flex;"><span>            Object result <span style="color:#f92672">=</span> jedis.<span style="color:#a6e22e">eval</span>(script, Collections.<span style="color:#a6e22e">singletonList</span>(lockKey),
</span></span><span style="display:flex;"><span>                    Collections.<span style="color:#a6e22e">singletonList</span>(sessionId));
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span>(<span style="color:#e6db74">&#34;1&#34;</span>.<span style="color:#a6e22e">equals</span>(result.<span style="color:#a6e22e">toString</span>())){
</span></span><span style="display:flex;"><span>                System.<span style="color:#a6e22e">out</span>.<span style="color:#a6e22e">println</span>(Thread.<span style="color:#a6e22e">currentThread</span>().<span style="color:#a6e22e">getName</span>() <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34; - 释放锁成功&#34;</span>);
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">true</span>;
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>            System.<span style="color:#a6e22e">out</span>.<span style="color:#a6e22e">println</span>(Thread.<span style="color:#a6e22e">currentThread</span>().<span style="color:#a6e22e">getName</span>() <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34; - 释放锁失败&#34;</span>);
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">false</span>;
</span></span><span style="display:flex;"><span>        }<span style="color:#66d9ef">finally</span> {
</span></span><span style="display:flex;"><span>            jedis.<span style="color:#a6e22e">close</span>();
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>Test01</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">/**
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> * 1、加锁
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> * 2、释放锁
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> * 3、程序意外死亡释放锁失败（利用超时闲时间防止死锁）
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> * 4、业务执行时间超过锁过期时间
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> */</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Test01</span> {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">static</span> String key <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;flash_1&#34;</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">static</span> String sessionId1 <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;session_id_1&#34;</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">static</span> String sessionId2 <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;session_id_2&#34;</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">main</span>(String<span style="color:#f92672">[]</span> args) {
</span></span><span style="display:flex;"><span>        ExecutorService executorService <span style="color:#f92672">=</span> Executors.<span style="color:#a6e22e">newFixedThreadPool</span>(2);
</span></span><span style="display:flex;"><span>        executorService.<span style="color:#a6e22e">execute</span>(() <span style="color:#f92672">-&gt;</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">try</span> {
</span></span><span style="display:flex;"><span>                LockUtil.<span style="color:#a6e22e">lock</span>(key, sessionId1);
</span></span><span style="display:flex;"><span>                System.<span style="color:#a6e22e">out</span>.<span style="color:#a6e22e">println</span>(Thread.<span style="color:#a6e22e">currentThread</span>().<span style="color:#a6e22e">getName</span>() <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34;业务执行中...&#34;</span>);
</span></span><span style="display:flex;"><span>                Thread.<span style="color:#a6e22e">sleep</span>(300);
</span></span><span style="display:flex;"><span>            } <span style="color:#66d9ef">catch</span> (Exception e) {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            } <span style="color:#66d9ef">finally</span> {
</span></span><span style="display:flex;"><span>                LockUtil.<span style="color:#a6e22e">unlock</span>(key, sessionId1);
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        });
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        executorService.<span style="color:#a6e22e">execute</span>(() <span style="color:#f92672">-&gt;</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">try</span> {
</span></span><span style="display:flex;"><span>                LockUtil.<span style="color:#a6e22e">lock</span>(key, sessionId2);
</span></span><span style="display:flex;"><span>                System.<span style="color:#a6e22e">out</span>.<span style="color:#a6e22e">println</span>(Thread.<span style="color:#a6e22e">currentThread</span>().<span style="color:#a6e22e">getName</span>() <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34;业务执行中...&#34;</span>);
</span></span><span style="display:flex;"><span>                Thread.<span style="color:#a6e22e">sleep</span>(300);
</span></span><span style="display:flex;"><span>            } <span style="color:#66d9ef">catch</span> (Exception e) {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            } <span style="color:#66d9ef">finally</span> {
</span></span><span style="display:flex;"><span>                LockUtil.<span style="color:#a6e22e">unlock</span>(key, sessionId2);
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        });
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>LockUtil2</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">LockUtil2</span> {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">final</span> JedisPool JEDIS_POOL;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/** 锁过期时间 */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">final</span> <span style="color:#66d9ef">long</span> INTERNAL_LOCK_LEASE_TIME <span style="color:#f92672">=</span> 5000;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">final</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">long</span> TIME_OUT <span style="color:#f92672">=</span> 20000; <span style="color:#75715e">//获取锁的超时时间</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">static</span> {
</span></span><span style="display:flex;"><span>        JEDIS_POOL <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> JedisPool(<span style="color:#e6db74">&#34;139.9.183.232&#34;</span>, 6379);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">static</span> Jedis <span style="color:#a6e22e">getJedis</span>() {
</span></span><span style="display:flex;"><span>        Jedis resource <span style="color:#f92672">=</span> JEDIS_POOL.<span style="color:#a6e22e">getResource</span>();
</span></span><span style="display:flex;"><span>        resource.<span style="color:#a6e22e">auth</span>(<span style="color:#e6db74">&#34;yuanmoc&#34;</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> resource;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">boolean</span> <span style="color:#a6e22e">lock</span>(String lockKey, String sessionId) {
</span></span><span style="display:flex;"><span>        Jedis jedis <span style="color:#f92672">=</span> getJedis();
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">long</span> start <span style="color:#f92672">=</span> System.<span style="color:#a6e22e">currentTimeMillis</span>();
</span></span><span style="display:flex;"><span>        String script <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;if (redis.call(&#39;exists&#39;, KEYS[1]) == 0) then &#34;</span> <span style="color:#f92672">+</span>
</span></span><span style="display:flex;"><span>                            <span style="color:#e6db74">&#34;redis.call(&#39;hset&#39;, KEYS[1], ARGV[2], 1); &#34;</span> <span style="color:#f92672">+</span>
</span></span><span style="display:flex;"><span>                            <span style="color:#e6db74">&#34;redis.call(&#39;pexpire&#39;, KEYS[1], ARGV[1]); &#34;</span> <span style="color:#f92672">+</span>
</span></span><span style="display:flex;"><span>                            <span style="color:#e6db74">&#34;return nil; &#34;</span> <span style="color:#f92672">+</span>
</span></span><span style="display:flex;"><span>                        <span style="color:#e6db74">&#34;end; &#34;</span> <span style="color:#f92672">+</span>
</span></span><span style="display:flex;"><span>                        <span style="color:#e6db74">&#34;if (redis.call(&#39;hexists&#39;, KEYS[1], ARGV[2]) == 1) then &#34;</span> <span style="color:#f92672">+</span>
</span></span><span style="display:flex;"><span>                            <span style="color:#e6db74">&#34;redis.call(&#39;hincrby&#39;, KEYS[1], ARGV[2], 1); &#34;</span> <span style="color:#f92672">+</span>
</span></span><span style="display:flex;"><span>                            <span style="color:#e6db74">&#34;redis.call(&#39;pexpire&#39;, KEYS[1], ARGV[1]); &#34;</span> <span style="color:#f92672">+</span>
</span></span><span style="display:flex;"><span>                            <span style="color:#e6db74">&#34;return nil; &#34;</span> <span style="color:#f92672">+</span>
</span></span><span style="display:flex;"><span>                        <span style="color:#e6db74">&#34;end; &#34;</span> <span style="color:#f92672">+</span>
</span></span><span style="display:flex;"><span>                        <span style="color:#e6db74">&#34;return redis.call(&#39;pttl&#39;, KEYS[1]);&#34;</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">try</span>{
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">for</span>(;;){
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>                System.<span style="color:#a6e22e">out</span>.<span style="color:#a6e22e">println</span>(Thread.<span style="color:#a6e22e">currentThread</span>().<span style="color:#a6e22e">getName</span>() <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34; - 正在获取锁&#34;</span>);
</span></span><span style="display:flex;"><span>                Object eval <span style="color:#f92672">=</span> jedis.<span style="color:#a6e22e">eval</span>(script, Collections.<span style="color:#a6e22e">singletonList</span>(lockKey),
</span></span><span style="display:flex;"><span>                        Arrays.<span style="color:#a6e22e">asList</span>(INTERNAL_LOCK_LEASE_TIME <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34;&#34;</span>, sessionId));
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">if</span>(eval <span style="color:#f92672">==</span> <span style="color:#66d9ef">null</span>){
</span></span><span style="display:flex;"><span>                    System.<span style="color:#a6e22e">out</span>.<span style="color:#a6e22e">println</span>(Thread.<span style="color:#a6e22e">currentThread</span>().<span style="color:#a6e22e">getName</span>() <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34; - 获取锁成功&#34;</span>);
</span></span><span style="display:flex;"><span>                    <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">true</span>;
</span></span><span style="display:flex;"><span>                }
</span></span><span style="display:flex;"><span>                <span style="color:#75715e">// 否则循环等待，在timeout时间内仍未获取到锁，则获取失败</span>
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">long</span> l <span style="color:#f92672">=</span> System.<span style="color:#a6e22e">currentTimeMillis</span>() <span style="color:#f92672">-</span> start;
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">if</span> (l <span style="color:#f92672">&gt;=</span> TIME_OUT) {
</span></span><span style="display:flex;"><span>                    System.<span style="color:#a6e22e">out</span>.<span style="color:#a6e22e">println</span>(Thread.<span style="color:#a6e22e">currentThread</span>().<span style="color:#a6e22e">getName</span>() <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34; - 获取锁超时&#34;</span>);
</span></span><span style="display:flex;"><span>                    <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">false</span>;
</span></span><span style="display:flex;"><span>                }
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">try</span> {
</span></span><span style="display:flex;"><span>                    Thread.<span style="color:#a6e22e">sleep</span>(100);
</span></span><span style="display:flex;"><span>                } <span style="color:#66d9ef">catch</span> (InterruptedException e) {
</span></span><span style="display:flex;"><span>                    e.<span style="color:#a6e22e">printStackTrace</span>();
</span></span><span style="display:flex;"><span>                }
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        }<span style="color:#66d9ef">finally</span> {
</span></span><span style="display:flex;"><span>            jedis.<span style="color:#a6e22e">close</span>();
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">boolean</span> <span style="color:#a6e22e">unlock</span>(String lockKey, String sessionId){
</span></span><span style="display:flex;"><span>        Jedis jedis <span style="color:#f92672">=</span> getJedis();
</span></span><span style="display:flex;"><span>        String script <span style="color:#f92672">=</span>
</span></span><span style="display:flex;"><span>                <span style="color:#75715e">// 如果锁已经不存在</span>
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#34;if (redis.call(&#39;exists&#39;, KEYS[1]) == 0) then &#34;</span> <span style="color:#f92672">+</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#e6db74">&#34;return 1; &#34;</span> <span style="color:#f92672">+</span>
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#34;end;&#34;</span> <span style="color:#f92672">+</span>
</span></span><span style="display:flex;"><span>                <span style="color:#75715e">// 如果释放锁的线程和已存在锁的线程不是同一个线程，返回null</span>
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#34;if (redis.call(&#39;hexists&#39;, KEYS[1], ARGV[2]) == 0) then &#34;</span> <span style="color:#f92672">+</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#e6db74">&#34;return nil;&#34;</span> <span style="color:#f92672">+</span>
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#34;end; &#34;</span> <span style="color:#f92672">+</span>
</span></span><span style="display:flex;"><span>                <span style="color:#75715e">// 通过hincrby递减1的方式，释放一次锁</span>
</span></span><span style="display:flex;"><span>                <span style="color:#75715e">// 若剩余次数大于0 ，则刷新过期时间</span>
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#34;local counter = redis.call(&#39;hincrby&#39;, KEYS[1], ARGV[2], -1); &#34;</span> <span style="color:#f92672">+</span>
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#34;if (counter &gt; 0) then &#34;</span> <span style="color:#f92672">+</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#e6db74">&#34;redis.call(&#39;pexpire&#39;, KEYS[1], ARGV[1]); &#34;</span> <span style="color:#f92672">+</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#e6db74">&#34;return 0; &#34;</span> <span style="color:#f92672">+</span>
</span></span><span style="display:flex;"><span>                <span style="color:#75715e">// 否则证明锁已经释放，删除key</span>
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#34;else &#34;</span> <span style="color:#f92672">+</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#e6db74">&#34;redis.call(&#39;del&#39;, KEYS[1]); &#34;</span> <span style="color:#f92672">+</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#e6db74">&#34;return 1; &#34;</span><span style="color:#f92672">+</span>
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#34;end; &#34;</span> <span style="color:#f92672">+</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#e6db74">&#34;return nil;&#34;</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">try</span> {
</span></span><span style="display:flex;"><span>            Object result <span style="color:#f92672">=</span> jedis.<span style="color:#a6e22e">eval</span>(script, Collections.<span style="color:#a6e22e">singletonList</span>(lockKey),
</span></span><span style="display:flex;"><span>                    Arrays.<span style="color:#a6e22e">asList</span>(INTERNAL_LOCK_LEASE_TIME <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34;&#34;</span>, sessionId));
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span>(result <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span>){
</span></span><span style="display:flex;"><span>                System.<span style="color:#a6e22e">out</span>.<span style="color:#a6e22e">println</span>(Thread.<span style="color:#a6e22e">currentThread</span>().<span style="color:#a6e22e">getName</span>() <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34; - 释放锁成功&#34;</span>);
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">true</span>;
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>            System.<span style="color:#a6e22e">out</span>.<span style="color:#a6e22e">println</span>(Thread.<span style="color:#a6e22e">currentThread</span>().<span style="color:#a6e22e">getName</span>() <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34; - 释放锁失败&#34;</span>);
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">false</span>;
</span></span><span style="display:flex;"><span>        }<span style="color:#66d9ef">finally</span> {
</span></span><span style="display:flex;"><span>            jedis.<span style="color:#a6e22e">close</span>();
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>test2</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">/**
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> * 1、可重入锁
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> */</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Test02</span> {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">static</span> String key <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;flash_1&#34;</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">static</span> String sessionId1 <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;session_id_1&#34;</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">static</span> String sessionId2 <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;session_id_2&#34;</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">main</span>(String<span style="color:#f92672">[]</span> args) {
</span></span><span style="display:flex;"><span>        ExecutorService executorService <span style="color:#f92672">=</span> Executors.<span style="color:#a6e22e">newFixedThreadPool</span>(5);
</span></span><span style="display:flex;"><span>        executorService.<span style="color:#a6e22e">execute</span>(() <span style="color:#f92672">-&gt;</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">try</span> {
</span></span><span style="display:flex;"><span>                LockUtil2.<span style="color:#a6e22e">lock</span>(key, sessionId1);
</span></span><span style="display:flex;"><span>                System.<span style="color:#a6e22e">out</span>.<span style="color:#a6e22e">println</span>(Thread.<span style="color:#a6e22e">currentThread</span>().<span style="color:#a6e22e">getName</span>() <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34; - 业务执行中...&#34;</span>);
</span></span><span style="display:flex;"><span>                Thread.<span style="color:#a6e22e">sleep</span>(300);
</span></span><span style="display:flex;"><span>            } <span style="color:#66d9ef">catch</span> (Exception e) {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            } <span style="color:#66d9ef">finally</span> {
</span></span><span style="display:flex;"><span>                LockUtil2.<span style="color:#a6e22e">unlock</span>(key, sessionId1);
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        });
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        executorService.<span style="color:#a6e22e">execute</span>(() <span style="color:#f92672">-&gt;</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">try</span> {
</span></span><span style="display:flex;"><span>                LockUtil2.<span style="color:#a6e22e">lock</span>(key, sessionId1);
</span></span><span style="display:flex;"><span>                System.<span style="color:#a6e22e">out</span>.<span style="color:#a6e22e">println</span>(Thread.<span style="color:#a6e22e">currentThread</span>().<span style="color:#a6e22e">getName</span>() <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34; - 业务执行中...&#34;</span>);
</span></span><span style="display:flex;"><span>                Thread.<span style="color:#a6e22e">sleep</span>(300);
</span></span><span style="display:flex;"><span>            } <span style="color:#66d9ef">catch</span> (Exception e) {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            } <span style="color:#66d9ef">finally</span> {
</span></span><span style="display:flex;"><span>                LockUtil2.<span style="color:#a6e22e">unlock</span>(key, sessionId1);
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        });
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        executorService.<span style="color:#a6e22e">execute</span>(() <span style="color:#f92672">-&gt;</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">try</span> {
</span></span><span style="display:flex;"><span>                LockUtil2.<span style="color:#a6e22e">lock</span>(key, sessionId2);
</span></span><span style="display:flex;"><span>                System.<span style="color:#a6e22e">out</span>.<span style="color:#a6e22e">println</span>(Thread.<span style="color:#a6e22e">currentThread</span>().<span style="color:#a6e22e">getName</span>() <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34; - 业务执行中...&#34;</span>);
</span></span><span style="display:flex;"><span>                Thread.<span style="color:#a6e22e">sleep</span>(300);
</span></span><span style="display:flex;"><span>            } <span style="color:#66d9ef">catch</span> (Exception e) {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            } <span style="color:#66d9ef">finally</span> {
</span></span><span style="display:flex;"><span>                LockUtil2.<span style="color:#a6e22e">unlock</span>(key, sessionId2);
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        });
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>其他</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">static</span> Map<span style="color:#f92672">&lt;</span>String, Map<span style="color:#f92672">&lt;</span>Thread, Timer<span style="color:#f92672">&gt;&gt;</span> expirationRenewalMap <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> ArrayList<span style="color:#f92672">&lt;&gt;</span>(0);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">scheduleExpirationRenewal</span>(String lockKey, String sessionId, Thread thread) {
</span></span><span style="display:flex;"><span>        Map<span style="color:#f92672">&lt;</span>Thread, Timer<span style="color:#f92672">&gt;</span> timerMap <span style="color:#f92672">=</span> expirationRenewalMap.<span style="color:#a6e22e">get</span>(lockKey <span style="color:#f92672">+</span> sessionId);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> (timerMap <span style="color:#f92672">==</span> <span style="color:#66d9ef">null</span>) {
</span></span><span style="display:flex;"><span>            timerMap <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> HashMap<span style="color:#f92672">&lt;&gt;</span>();
</span></span><span style="display:flex;"><span>        } <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">for</span> (Thread thread1 : timerMap.<span style="color:#a6e22e">keySet</span>()) {
</span></span><span style="display:flex;"><span>                timerMap.<span style="color:#a6e22e">get</span>(thread1).<span style="color:#a6e22e">cancel</span>();
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">long</span> period <span style="color:#f92672">=</span> INTERNAL_LOCK_LEASE_TIME <span style="color:#f92672">/</span> 3L;
</span></span><span style="display:flex;"><span>        Timer timer <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> Timer();
</span></span><span style="display:flex;"><span>        timer.<span style="color:#a6e22e">scheduleAtFixedRate</span>(<span style="color:#66d9ef">new</span> ExpirationRenewalTimerTask(lockKey, thread), period, period);
</span></span><span style="display:flex;"><span>        timerMap.<span style="color:#a6e22e">put</span>(thread, timer);
</span></span><span style="display:flex;"><span>        expirationRenewalMap.<span style="color:#a6e22e">put</span>(lockKey <span style="color:#f92672">+</span> sessionId, timerMap);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">ExpirationRenewalTimerTask</span> <span style="color:#66d9ef">extends</span> TimerTask {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">public</span> <span style="color:#a6e22e">ExpirationRenewalTimerTask</span>(String lockKey, Thread thread) {
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">lockKey</span> <span style="color:#f92672">=</span> lockKey;
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">thread</span> <span style="color:#f92672">=</span> thread;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">private</span> String lockKey;
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">private</span> Thread thread;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">@Override</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">run</span>() {
</span></span><span style="display:flex;"><span>            Map<span style="color:#f92672">&lt;</span>Thread, Timer<span style="color:#f92672">&gt;</span> timerMap <span style="color:#f92672">=</span> expirationRenewalMap.<span style="color:#a6e22e">get</span>(lockKey);
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> (timerMap <span style="color:#f92672">==</span> <span style="color:#66d9ef">null</span>) {
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">return</span>;
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">for</span> (Thread thread1 : timerMap.<span style="color:#a6e22e">keySet</span>()) {
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span>thread1.<span style="color:#a6e22e">isAlive</span>()) {
</span></span><span style="display:flex;"><span>                    Timer timer <span style="color:#f92672">=</span> timerMap.<span style="color:#a6e22e">get</span>(thread1);
</span></span><span style="display:flex;"><span>                    timer.<span style="color:#a6e22e">cancel</span>();
</span></span><span style="display:flex;"><span>                }
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            Jedis jedis <span style="color:#f92672">=</span> getJedis();
</span></span><span style="display:flex;"><span>            String script <span style="color:#f92672">=</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#e6db74">&#34;if (redis.call(&#39;hexists&#39;, KEYS[1], ARGV[2]) == 1) then &#34;</span> <span style="color:#f92672">+</span>
</span></span><span style="display:flex;"><span>                            <span style="color:#e6db74">&#34;redis.call(&#39;pexpire&#39;, KEYS[1], ARGV[1]); &#34;</span> <span style="color:#f92672">+</span>
</span></span><span style="display:flex;"><span>                            <span style="color:#e6db74">&#34;return 1; &#34;</span> <span style="color:#f92672">+</span>
</span></span><span style="display:flex;"><span>                            <span style="color:#e6db74">&#34;end; &#34;</span> <span style="color:#f92672">+</span>
</span></span><span style="display:flex;"><span>                            <span style="color:#e6db74">&#34;return 0;&#34;</span>;
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">try</span> {
</span></span><span style="display:flex;"><span>                Object result <span style="color:#f92672">=</span> jedis.<span style="color:#a6e22e">eval</span>(script, Collections.<span style="color:#a6e22e">singletonList</span>(lockKey),
</span></span><span style="display:flex;"><span>                        Arrays.<span style="color:#a6e22e">asList</span>(INTERNAL_LOCK_LEASE_TIME <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34;&#34;</span>, sessionId));
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">if</span>(result <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span>){
</span></span><span style="display:flex;"><span>                    System.<span style="color:#a6e22e">out</span>.<span style="color:#a6e22e">println</span>(sessionId <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34; - 续租锁成功&#34;</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>                }
</span></span><span style="display:flex;"><span>            }<span style="color:#66d9ef">finally</span> {
</span></span><span style="display:flex;"><span>                jedis.<span style="color:#a6e22e">close</span>();
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span></code></pre></div></article>
 
      

      <footer class="book-footer">
        
  <div class="flex flex-wrap justify-between">




  <div>
    <a class="flex align-center" href="https://github.com/alex-shpak/hugo-book/edit/main/exampleSite/content/posts/history/Redis%e5%88%86%e5%b8%83%e5%bc%8f%e9%94%81.md" target="_blank" rel="noopener">
      <img src="/svg/edit.svg" class="book-icon" alt="Edit" />
      <span>Edit this page</span>
    </a>
  </div>


</div>



  <script>(function(){function e(e){const t=window.getSelection(),n=document.createRange();n.selectNodeContents(e),t.removeAllRanges(),t.addRange(n)}document.querySelectorAll("pre code").forEach(t=>{t.addEventListener("click",function(){if(window.getSelection().toString())return;e(t.parentElement),navigator.clipboard&&navigator.clipboard.writeText(t.parentElement.textContent)})})})()</script>


 
        
      </footer>

      
  
  <div class="book-comments">

</div>
  
 

      <label for="menu-control" class="hidden book-menu-overlay"></label>
    </div>

    
    <aside class="book-toc">
      <div class="book-toc-content">
        
  
<nav id="TableOfContents"></nav>


 
      </div>
    </aside>
    
  </main>

  
</body>
</html>












